(function(k,g){Croppic=function(a,b){this.id=a;this.outputDiv=this.obj=$("#"+a);this.options={uploadUrl:"",uploadData:{},cropUrl:"",cropData:{},outputUrlId:"",imgEyecandy:!0,imgEyecandyOpacity:.2,zoomFactor:10,rotateFactor:5,doubleZoomControls:!0,rotateControls:!0,modal:!1,customUploadButtonId:"",loaderHtml:"",scaleToFill:!0,processInline:!1,loadPicture:"",onReset:null,enableMousescroll:!1,onBeforeImgUpload:null,onAfterImgUpload:null,onImgDrag:null,onImgZoom:null,onImgRotate:null,onBeforeImgCrop:null,
onAfterImgCrop:null,checkFileSize:null,onError:null};for(i in b)this.options[i]=b[i];this.init()};Croppic.prototype={id:"",imgInitW:0,imgInitH:0,imgW:0,imgH:0,objW:0,objH:0,actualRotation:0,windowW:0,windowH:$(k).height(),obj:{},outputDiv:{},outputUrlObj:{},img:{},defaultImg:{},croppedImg:{},imgEyecandy:{},form:{},cropControlsUpload:{},cropControlsCrop:{},cropControlZoomMuchIn:{},cropControlZoomMuchOut:{},cropControlZoomIn:{},cropControlZoomOut:{},cropControlCrop:{},cropControlReset:{},cropControlRemoveCroppedImage:{},
modal:{},loader:{},init:function(){this.objW=this.obj.width();this.objH=this.obj.height();this.actualRotation=0;$.isEmptyObject(this.defaultImg)&&(this.defaultImg=this.obj.find("img"));this.createImgUploadControls();$.isEmptyObject(this.options.loadPicture)?this.bindImgUploadControl():this.loadExistingImage()},createImgUploadControls:function(){var a="";""===this.options.customUploadButtonId&&(a='<i class="cropControlUpload"></i>');var b='<i class="cropControlRemoveCroppedImage"></i>';$.isEmptyObject(this.croppedImg)&&
(b="");$.isEmptyObject(this.options.loadPicture)||(a="");this.outputDiv.append('<div class="cropControls cropControlsUpload"> '+a+b+" </div>");this.cropControlsUpload=this.outputDiv.find(".cropControlsUpload");""===this.options.customUploadButtonId?this.imgUploadControl=this.outputDiv.find(".cropControlUpload"):(this.imgUploadControl=$("#"+this.options.customUploadButtonId),this.imgUploadControl.show());$.isEmptyObject(this.croppedImg)||(this.cropControlRemoveCroppedImage=this.outputDiv.find(".cropControlRemoveCroppedImage"))},
bindImgUploadControl:function(){var a=this;a.outputDiv.append('<form class="'+a.id+'_imgUploadForm" style="position: absolute; visibility: hidden; top:0;">  <input type="file" name="img">  </form>');a.form=a.outputDiv.find("."+a.id+"_imgUploadForm");a.imgUploadControl.off("click");a.imgUploadControl.on("click",function(){a.form.find('input[type="file"]').trigger("click")});if(!$.isEmptyObject(a.croppedImg))a.cropControlRemoveCroppedImage.on("click",function(){a.croppedImg.remove();$(this).hide();
$.isEmptyObject(a.defaultImg)||a.obj.append(a.defaultImg);""!==a.options.outputUrlId&&$("#"+a.options.outputUrlId).val("")});a.form.find('input[type="file"]').change(function(){if(a.options.checkFileSize&&!a.options.checkFileSize(a.form.find('input[type="file"]')[0].files[0].size))return!1;a.options.onBeforeImgUpload&&a.options.onBeforeImgUpload.call(a);a.showLoader();a.imgUploadControl.hide();if(a.options.processInline){var b=new FileReader;b.onload=function(b){var c=new Image;c.src=b.target.result;
c.onload=function(){a.imgInitW=a.imgW=c.width;a.imgInitH=a.imgH=c.height;a.options.modal&&a.createModal();$.isEmptyObject(a.croppedImg)||a.croppedImg.remove();a.imgUrl=c.src;a.obj.append('<img src="'+c.src+'">');a.initCropper();a.hideLoader();a.options.onAfterImgUpload&&a.options.onAfterImgUpload.call(a)}};b.readAsDataURL(a.form.find('input[type="file"]')[0].files[0])}else{var b=new FormData(a.form[0]),c;for(c in a.options.uploadData)a.options.uploadData.hasOwnProperty(c)&&b.append(c,a.options.uploadData[c]);
$.ajax({url:a.options.uploadUrl,data:b,context:g.body,cache:!1,contentType:!1,processData:!1,type:"POST"}).always(function(b){response="object"==typeof b?b:jQuery.parseJSON(b);"success"==response.status&&(a.imgInitW=a.imgW=response.width,a.imgInitH=a.imgH=response.height,a.options.modal&&a.createModal(),$.isEmptyObject(a.croppedImg)||a.croppedImg.remove(),a.imgUrl=response.url,b=$('<img src="'+response.url+'">'),a.obj.append(b),b.load(function(){a.initCropper();a.hideLoader();a.options.onAfterImgUpload&&
a.options.onAfterImgUpload.call(a)}));"error"==response.status&&(a.options.onError&&a.options.onError.call(a,response.message),a.hideLoader(),setTimeout(function(){a.reset()},2E3))})}})},loadExistingImage:function(){var a=this;if($.isEmptyObject(a.croppedImg)){a.options.onBeforeImgUpload&&a.options.onBeforeImgUpload.call(a);a.showLoader();a.options.modal&&a.createModal();$.isEmptyObject(a.croppedImg)||a.croppedImg.remove();a.imgUrl=a.options.loadPicture;var b=$('<img src="'+a.options.loadPicture+
'">');a.obj.append(b);b.load(function(){a.imgInitW=a.imgW=this.width;a.imgInitH=a.imgH=this.height;a.initCropper();a.hideLoader();a.options.onAfterImgUpload&&a.options.onAfterImgUpload.call(a)})}else a.cropControlRemoveCroppedImage.on("click",function(){a.croppedImg.remove();$(this).hide();$.isEmptyObject(a.defaultImg)||a.obj.append(a.defaultImg);""!==a.options.outputUrlId&&$("#"+a.options.outputUrlId).val("");a.croppedImg="";a.reset()})},createModal:function(){var a='<div id="croppicModal"><div id="croppicModalObj" style="width:'+
this.objW+"px; height:"+this.objH+"px; margin:0 auto; margin-top:"+(this.windowH/2-this.objH/2)+'px; position: relative;"> </div></div>';$("body").append(a);this.modal=$("#croppicModal");this.obj=$("#croppicModalObj")},destroyModal:function(){this.obj=this.outputDiv;this.modal.remove()},initCropper:function(){this.img=this.obj.find("img");this.img.wrap('<div class="cropImgWrapper" style="overflow:hidden; z-index:1; position:absolute; width:'+this.objW+"px; height:"+this.objH+'px;"></div>');this.createCropControls();
this.options.imgEyecandy&&this.createEyecandy();this.initDrag();this.initialScaleImg()},createEyecandy:function(){this.imgEyecandy=this.img.clone();this.imgEyecandy.css({"z-index":"0",opacity:this.options.imgEyecandyOpacity}).appendTo(this.obj)},destroyEyecandy:function(){this.imgEyecandy.remove()},initialScaleImg:function(){var a=this;a.zoom(-a.imgInitW);a.zoom(40);if(a.options.enableMousescroll)a.img.on("mousewheel",function(b){b.preventDefault();a.zoom(a.options.zoomFactor*b.deltaY)});a.img.css({left:-(a.imgW-
a.objW)/2,top:-(a.imgH-a.objH)/2,position:"relative"});a.options.imgEyecandy&&a.imgEyecandy.css({left:-(a.imgW-a.objW)/2,top:-(a.imgH-a.objH)/2,position:"relative"})},createCropControls:function(){var a=this,b="",c="",d="",e="";a.options.doubleZoomControls&&(b='<i class="cropControlZoomMuchIn"></i>',c='<i class="cropControlZoomMuchOut"></i>');a.options.rotateControls&&(d='<i class="cropControlRotateLeft"></i>',e='<i class="cropControlRotateRight"></i>');a.obj.append('<div class="cropControls cropControlsCrop">'+
b+'<i class="cropControlZoomIn"></i><i class="cropControlZoomOut"></i>'+c+d+e+'<i class="cropControlCrop"></i><i class="cropControlReset"></i></div>');a.cropControlsCrop=a.obj.find(".cropControlsCrop");a.options.doubleZoomControls&&(a.cropControlZoomMuchIn=a.cropControlsCrop.find(".cropControlZoomMuchIn"),a.cropControlZoomMuchIn.on("click",function(){a.zoom(10*a.options.zoomFactor)}),a.cropControlZoomMuchOut=a.cropControlsCrop.find(".cropControlZoomMuchOut"),a.cropControlZoomMuchOut.on("click",function(){a.zoom(10*
-a.options.zoomFactor)}));a.cropControlZoomIn=a.cropControlsCrop.find(".cropControlZoomIn");a.cropControlZoomIn.on("click",function(){a.zoom(a.options.zoomFactor)});a.cropControlZoomOut=a.cropControlsCrop.find(".cropControlZoomOut");a.cropControlZoomOut.on("click",function(){a.zoom(-a.options.zoomFactor)});a.cropControlZoomIn=a.cropControlsCrop.find(".cropControlRotateLeft");a.cropControlZoomIn.on("click",function(){a.rotate(-a.options.rotateFactor)});a.cropControlZoomOut=a.cropControlsCrop.find(".cropControlRotateRight");
a.cropControlZoomOut.on("click",function(){a.rotate(a.options.rotateFactor)});a.cropControlCrop=a.cropControlsCrop.find(".cropControlCrop");a.cropControlCrop.on("click",function(){a.crop()});a.cropControlReset=a.cropControlsCrop.find(".cropControlReset");a.cropControlReset.on("click",function(){a.reset()})},initDrag:function(){var a=this;a.img.on("mousedown touchstart",function(b){b.preventDefault();var c,d=k.navigator.userAgent;d.match(/iPad/i)||d.match(/iPhone/i)||d.match(/android/i)?(c=b.originalEvent.touches[0].pageX,
b=b.originalEvent.touches[0].pageY):(c=b.pageX,b=b.pageY);var e=a.img.css("z-index"),f=a.img.outerHeight(),h=a.img.outerWidth(),g=a.img.offset().top+f-b,l=a.img.offset().left+h-c;a.img.css("z-index",1E3).on("mousemove touchmove",function(b){var c;d.match(/iPad/i)||d.match(/iPhone/i)||d.match(/android/i)?(c=b.originalEvent.touches[0].pageY+g-f,b=b.originalEvent.touches[0].pageX+l-h):(c=b.pageY+g-f,b=b.pageX+l-h);a.img.offset({top:c,left:b}).on("mouseup",function(){$(this).removeClass("draggable").css("z-index",
e)});a.options.imgEyecandy&&a.imgEyecandy.offset({top:c,left:b});a.objH<a.imgH?(0<parseInt(a.img.css("top"))&&(a.img.css("top",0),a.options.imgEyecandy&&a.imgEyecandy.css("top",0)),c=-(a.imgH-a.objH),parseInt(a.img.css("top"))<c&&(a.img.css("top",c),a.options.imgEyecandy&&a.imgEyecandy.css("top",c))):(0>parseInt(a.img.css("top"))&&(a.img.css("top",0),a.options.imgEyecandy&&a.imgEyecandy.css("top",0)),c=a.objH-a.imgH,parseInt(a.img.css("top"))>c&&(a.img.css("top",c),a.options.imgEyecandy&&a.imgEyecandy.css("top",
c)));a.objW<a.imgW?(0<parseInt(a.img.css("left"))&&(a.img.css("left",0),a.options.imgEyecandy&&a.imgEyecandy.css("left",0)),c=-(a.imgW-a.objW),parseInt(a.img.css("left"))<c&&(a.img.css("left",c),a.options.imgEyecandy&&a.imgEyecandy.css("left",c))):(0>parseInt(a.img.css("left"))&&(a.img.css("left",0),a.options.imgEyecandy&&a.imgEyecandy.css("left",0)),c=a.objW-a.imgW,parseInt(a.img.css("left"))>c&&(a.img.css("left",c),a.options.imgEyecandy&&a.imgEyecandy.css("left",c)));a.options.onImgDrag&&a.options.onImgDrag.call(a)})}).on("mouseup",
function(){a.img.off("mousemove")}).on("mouseout",function(){a.img.off("mousemove")})},rotate:function(a){this.actualRotation+=a;this.img.css({"-webkit-transform":"rotate("+this.actualRotation+"deg)","-moz-transform":"rotate("+this.actualRotation+"deg)",transform:"rotate("+this.actualRotation+"deg)"});this.options.imgEyecandy&&this.imgEyecandy.css({"-webkit-transform":"rotate("+this.actualRotation+"deg)","-moz-transform":"rotate("+this.actualRotation+"deg)",transform:"rotate("+this.actualRotation+
"deg)"});"function"==typeof this.options.onImgRotate&&this.options.onImgRotate.call(this)},zoom:function(a){var b=this.imgW/this.imgH,c=this.imgW+a,d=c/b,e=!0;if(c<this.objW||d<this.objH)c-this.objW<d-this.objH?(c=this.objW,d=c/b):(d=this.objH,c=b*d),e=!1;!this.options.scaleToFill&&(c>this.imgInitW||d>this.imgInitH)&&(c-this.imgInitW<d-this.imgInitH?(c=this.imgInitW,d=c/b):(d=this.imgInitH,c=b*d),e=!1);this.imgW=c;this.img.width(c);this.imgH=d;this.img.height(d);b=parseInt(this.img.css("top"))-a/
2;a=parseInt(this.img.css("left"))-a/2;0<b&&(b=0);0<a&&(a=0);var f=-(d-this.objH);b<f&&(b=f);f=-(c-this.objW);a<f&&(a=f);e&&this.img.css({top:b,left:a});this.options.imgEyecandy&&(this.imgEyecandy.width(c),this.imgEyecandy.height(d),e&&this.imgEyecandy.css({top:b,left:a}));this.options.onImgZoom&&this.options.onImgZoom.call(this)},crop:function(){var a=this;a.options.onBeforeImgCrop&&a.options.onBeforeImgCrop.call(a);a.cropControlsCrop.hide();a.showLoader();var b={imgUrl:a.imgUrl,imgInitW:a.imgInitW,
imgInitH:a.imgInitH,imgW:a.imgW,imgH:a.imgH,imgY1:Math.abs(parseInt(a.img.css("top"))),imgX1:Math.abs(parseInt(a.img.css("left"))),cropH:a.objH,cropW:a.objW,rotation:a.actualRotation},c=new FormData,d;for(d in b)b.hasOwnProperty(d)&&c.append(d,b[d]);for(d in a.options.cropData)a.options.cropData.hasOwnProperty(d)&&c.append(d,a.options.cropData[d]);$.ajax({url:a.options.cropUrl,data:c,context:g.body,cache:!1,contentType:!1,processData:!1,type:"POST"}).always(function(b){response="object"==typeof b?
b:jQuery.parseJSON(b);"success"==response.status&&(a.options.imgEyecandy&&a.imgEyecandy.hide(),a.destroy(),a.obj.append('<img class="croppedImg" src="'+response.url+'">'),""!==a.options.outputUrlId&&$("#"+a.options.outputUrlId).val(response.url),a.croppedImg=a.obj.find(".croppedImg"),a.init(),a.hideLoader());"error"==response.status&&(a.options.onError&&a.options.onError.call(a,response.message),a.hideLoader(),setTimeout(function(){a.reset()},2E3));a.options.onAfterImgCrop&&a.options.onAfterImgCrop.call(a)})},
showLoader:function(){this.obj.append(this.options.loaderHtml);this.loader=this.obj.find(".loader")},hideLoader:function(){this.loader.remove()},reset:function(){this.destroy();this.init();$.isEmptyObject(this.croppedImg)||(this.obj.append(this.croppedImg),""!==this.options.outputUrlId&&$("#"+this.options.outputUrlId).val(this.croppedImg.attr("url")));"function"==typeof this.options.onReset&&this.options.onReset.call(this)},destroy:function(){this.options.modal&&!$.isEmptyObject(this.modal)&&this.destroyModal();
this.options.imgEyecandy&&!$.isEmptyObject(this.imgEyecandy)&&this.destroyEyecandy();$.isEmptyObject(this.cropControlsUpload)||this.cropControlsUpload.remove();$.isEmptyObject(this.cropControlsCrop)||this.cropControlsCrop.remove();$.isEmptyObject(this.loader)||this.loader.remove();$.isEmptyObject(this.form)||this.form.remove();this.obj.html("")}}})(window,document);